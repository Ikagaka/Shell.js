<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>マリちゃんトークチャレンジ！</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=640px, initial-scale=0.5, maximum-scale=1.0">
    <script src="../bower_components/bluebird/js/browser/bluebird.min.js"></script>
    <script src="../bower_components/encoding-japanese/encoding.js"></script>
    <script src="../bower_components/jszip/dist/jszip.min.js"></script>
    <script src="../bower_components/narloader/NarLoader.js"></script>
    <script src="../bower_components/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
    <script src="../bower_components/lodash/lodash.min.js"></script>
    <script src="../bower_components/zepto/zepto.min.js"></script>
    <script src="../bower_components/ikagaka.sakurascriptplayer.js/lib/SakuraScriptPlayer.js"></script>
    <script src="../bower_components/cuttlebone/lib/cuttlebone.js"></script>
    <script src="WMDataURIScheme.min.js"></script>
    <script src="widgets.js"></script>
<script>
$(function(){

  if(sessionStorage["#code"]){
    $("#code").val(sessionStorage["#code"]);
  }

  if(location.hash.length > 0){
    var base64 = location.hash.slice(1);
    WMDataURIScheme.DataURIToString("data:text/plain;charset=utf-8;base64," + base64, function(err, code){
      if(err) throw err;
      $("#code").val(code);
    });
  }

  $("#code").keydown(function(){
    sessionStorage["#code"] = $("#code").val();
    var code = $("#code").val();
    WMDataURIScheme.StringToDataURI(code, "text/plain", function(err, scheme){
      if(err) throw err;
      var base64 = scheme.split(",")[1];
      var url = location.protocol + '//' +
                location.hostname +
                location.pathname +
                "#" + base64;
      $("#tweet").html($("<a />").attr({
        "href": "https://twitter.com/share",
        "class": "twitter-share-button",
        "data-size": "small",
        "data-text": "",
        "data-url": url,
        "data-hashtags": "ukaben",
        "data-count": "none",
        "data-lang": "ja"
      }).html("Tweet"));
      twttr.widgets.load();
    });
  }).keydown();

  var nmdmgr = new cuttlebone.NamedManager();
  $(nmdmgr.element).appendTo("body");

  NarLoader.loadFromURL("../bower_components/cuttlebone/nar/mobilemaster.nar")
  .then(function(nnkDir){
    console.log(nnkDir);
    return Promise.all([
      balloonLoadReady("switch_L")(nnkDir),
      shellLoadReady("shell/master")(nnkDir)
    ]);
  }).then(namedMaterializeReady(nmdmgr))
  .then(sSPlayReady);
});

function balloonLoadReady(path){
  return function(nnkDir){
    console.log(nnkDir)
    var balloonDir = nnkDir.getDirectory(path).asArrayBuffer();
    var balloon = new cuttlebone.Balloon(balloonDir);
    return balloon.load();
  };
}

function shellLoadReady(path){
  return function(nnkDir){
    console.log(nnkDir)
    var shellDir = nnkDir.getDirectory(path).asArrayBuffer();
    var shell = new cuttlebone.Shell(shellDir);
    return shell.load();
  };
}

function namedMaterializeReady (nmdmgr){
  return function(tuple) {
    console.log(nmdmgr, tuple)
    var hwnd = nmdmgr.materialize(tuple[1], tuple[0]);
    var named = nmdmgr.named(hwnd);
    return named.load();
  };
}

function sSPlayReady(named) {
  var ssp = new SakuraScriptPlayer(named);
  $("#play").click(function(){
    ssp.play($("#code").val().split("\n").join("\\n"));
    /*var sss = $("#code").val().split("\n");
    sss.reduce(function(prm, ss){
      var _ss = ss.replace(/[A-Za-z0-9\\\[\]]/g, "");
      var tuple = talk(_ss);
      return prm.then(function(){
        return tuple[0].then(function(){
          console.log("ssp start", ss);
          ssp.play(ss);
          return tuple[1];
        });
      });
    }, Promise.resolve());*/

  }).click();
}

function talk(text){
  // https://dvcs.w3.org/hg/speech-api/raw-file/tip/speechapi.html
  // http://www.w3.org/TR/speech-synthesis/
  var utterance = new SpeechSynthesisUtterance();
  utterance.text = text;
  utterance.rate = 0.8;
  utterance.pitch = 1;
  utterance.lang = "ja-JP";
  console.log(utterance);
  //http://stackoverflow.com/questions/21947730/chrome-speech-synthesis-with-longer-texts
  //IMPORTANT!! Do not remove: Logging the object out fixes some onend firing issues.
  //placing the speak invocation inside a callback fixes ordering and onend issues.
  speechSynthesis.speak(utterance);
  utterance.addEventListener("error", function(err){ console.error(err); reject(err); });
  return [
    new Promise(function(resolve, reject){
      utterance.addEventListener("start", function(){ console.log("ssu start", text); resolve()});
    }),
    new Promise(function(resolve, reject){
      utterance.addEventListener("end", function(){ console.log("ssu end"); resolve()});
    })
  ];
}

function wait(ms){
  return function(context){
    return new Promise(function(resolve, reject){
      setTimeout(function(){ resolve(context); }, ms);
    });
  };
}
</script>
<style>
#code {
  width: 300px;
  height: 300px;
}
#wrapper {
  display: inline-block;
}
</style>
</head><body>
<h1>マリちゃんトークチャレンジ！</h1>
<p>マリちゃんに恥ずかしいセリフを言わせてTwitterで共有しよう！</p>
<p>※narダウンロードに時間がかかります。10秒ほどお待ちください</p>
<fieldset id="wrapper">
<legend>台本</legend>
<input type="button" value="play" id="play" />
<span id="tweet"></span>
<p>
<textarea id="code" placeholder="\h\s[0]こんにちは！\w4世界！\w8">
\u\s[10]
\h\s[0]ドーモ、\w4CRTゅう＝サン。\w8マリです。\w8
\u\s[10]ドーモ、\w4マリ＝サン。\w8CRTゅうです。\w8
\h\s[7]CRTモニタ死すべし。\w8慈悲はない。\w8
\u\s[11]ニンジャ！\w8ニンジャナンデ！！？？\w8
\h\s[2]イヤーッ！\w8
\u\s[12]グワーッ！\w8
サヨナラ！\s[5000]\i[100]\w8
</textarea>
</p>
</fieldset>
<p><a href="https://github.com/Ikagaka/cuttlebone">github</a></p>
</body>
</html>
