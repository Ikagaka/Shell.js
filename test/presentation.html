<!--script src="../bower_components/bluebird/js/browser/bluebird.min.js"></script-->
<script src="../bower_components/encoding-japanese/encoding.js"></script>
<script src="../bower_components/jszip/dist/jszip.min.js"></script>
<script src="../bower_components/narloader/NarLoader.js"></script>
<script src="../bower_components/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="../bower_components/lodash/lodash.min.js"></script>
<script src="../bower_components/zepto/zepto.min.js"></script>
<script src="../bower_components/ikagaka.sakurascriptplayer.js/lib/sakurascriptplayer.js"></script>
<script src="../lib/cuttlebone.js"></script>
<script src="WMURLShortener.min.js"></script>
<script src="WMDataURIScheme.min.js"></script>
<script>
$(function(){

  if(sessionStorage["#code"]){
    $("#code").val(sessionStorage["#code"]);
  }

  if(location.hash.length > 0){
    var base64 = location.hash.slice(1);
    WMDataURIScheme.DataURIToString("data:text/plain;charset=utf-8;base64," + base64, function(err, code){
      if(err) throw err;
      $("#code").val(code);
    });
  }

  $("#code").keypress(function(){
    sessionStorage["#code"] = $("#code").val();
  });

  $("#tweet").mousedown(function(){
    var code = $("#code").val();
    WMDataURIScheme.StringToDataURI(code, "text/plain", function(err, scheme){
      if(err) throw err;
      var base64 = scheme.split(",")[1];
      var url = location.protocol + '//' +
                location.hostname +
                ":" + location.port +
                location.pathname +
                "#" + base64;
      var shrn = new WMURLShortener()
      shrn.shorten(url, function(err, surl){
        console.log(err)
        if(err) surl = url;
        $("#tweet").attr("href", "https://twitter.com/share?hashtags="+encodeURIComponent("MARICHANG")+"&url="+encodeURIComponent(surl));
      });
    });
  });

  var nmdmgr = new cuttlebone.NamedManager();
  $(nmdmgr.element).appendTo("body");
  Promise.all([
    NarLoader.loadFromURL("../nar/mobilemaster.nar").then(balloonLoadReady("switch_L")),
    NarLoader.loadFromURL("../nar/mobilemaster.nar").then(shellLoadReady("shell/master"))
  ])
  .then(namedMaterializeReady(nmdmgr))
  .then(sSPlayReady);
});
function balloonLoadReady(path){
  return function(nnkDir){
    console.log(nnkDir)
    var balloonDir = nnkDir.getDirectory(path).asArrayBuffer();
    var balloon = new cuttlebone.Balloon(balloonDir);
    return balloon.load();
  };
}

function shellLoadReady(path){
  return function(nnkDir){
    console.log(nnkDir)
    var shellDir = nnkDir.getDirectory(path).asArrayBuffer();
    var shell = new cuttlebone.Shell(shellDir);
    return shell.load();
  };
}

function namedMaterializeReady (nmdmgr){
  return function(tuple) {
    console.log(nmdmgr, tuple)
    var hwnd = nmdmgr.materialize(tuple[1], tuple[0]);
    var named = nmdmgr.named(hwnd);
    return named.load();
  };
}

function sSPlayReady(named) {
  var ssp = new SakuraScriptPlayer(named);
  $("#play").click(function(){
    var sss = $("#code").val().split("\n");
    sss.reduce(function(prm, ss){
      var _ss = ss.replace(/[A-Za-z0-9\\\[\]]|![<A-Za-z>]/g, "")
      var tuple = talk(_ss);
      return prm.then(function(){
        return tuple[0].then(function(){
          console.log("ssp start", ss);
          ssp.play(ss);
          return tuple[1];
        });
      });
    }, Promise.resolve());

  }).click();
}

function talk(text){
  var utterance = new SpeechSynthesisUtterance();
  utterance.text = text;
  utterance.rate = 0.8;
  utterance.pitch = 1;
  utterance.lang = "ja-JP";
  console.log(utterance);
  //http://stackoverflow.com/questions/21947730/chrome-speech-synthesis-with-longer-texts
  //IMPORTANT!! Do not remove: Logging the object out fixes some onend firing issues.
  //placing the speak invocation inside a callback fixes ordering and onend issues.
  speechSynthesis.speak(utterance);
  utterance.addEventListener("error", function(err){ console.error(err); reject(err); });
  return [
    new Promise(function(resolve, reject){
      utterance.addEventListener("start", function(){ console.log("ssu start", text); resolve()});
    }),
    new Promise(function(resolve, reject){
      utterance.addEventListener("end", function(){ console.log("ssu end"); resolve()});
    })
  ];
}

function wait(ms){
  return function(context){
    return new Promise(function(resolve, reject){
      setTimeout(function(){ resolve(context); }, ms);
    });
  };
}
</script>
<style>
#code {
  width: 300px;
  height: 300px;
}
#wrapper {
  display: inline-block;
}
.blimpText {
  font-size: 30px !important;
}
</style>
<h1>マリちゃんトークチャレンジ！</h1>
<p>マリちゃんに恥ずかしいセリフを言わせてTwitterで共有しよう！</p>
<fieldset id="wrapper">
<legend>台本</legend>
<input type="button" value="play" id="play" />
<a id="tweet" href="https://twitter.com/share" target="_blank">Tweet</a>
<p>
<textarea id="code" placeholder="\h\s[0]こんにちは！\w4世界！\w8">
\h\s[0]こんにちは！\w4世界！\w8
\u\s[10]こんにちは！\w4世界！\w8
\h\s[1]\cもー、大井っちー、体触るのやーめーてーよー！\w8
\u\s[10]・・・。\w8
\h\s[2]目を離さないでって言ったのにー！\w4提督ゥ！\w4何してるデース！\w8
\u\s[11]\cおぅ、そのへんにしときや。\e
</textarea>
</p>
</fieldset>
