<script src="../node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="../node_modules/ikagaka.nar.js/vendor/jszip.min.js"></script>
<script src="../node_modules/ikagaka.nar.js/vendor/XHRProxy.min.js"></script>
<script src="../node_modules/ikagaka.nar.js/vendor/WMDescript.js"></script>
<script src="../node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="../node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="../node_modules/underscore/underscore-min.js"></script>
<script src="../node_modules/zepto/zepto.min.js"></script>
<script src="../node_modules/es6-shim/es6-shim.min.js"></script>
<script src="../SurfaceUtil.js"></script>
<script src="../Surface.js"></script>
<script src="../Shell.js"></script>
<p>
  nar: <input type="file" id="nar" />
  surface: <input type="number" value="0" id="surfaceId" />
</p>
<script>
/*
Nar.Loader.wget("./surfaces.txt", "text", function(err, data){
  var parsed = Shell.parseSurfaces(data);
  console.log(parsed.surfaces.surface0);
})*/



$("#nar").change(function(ev){
  var loader = new Nar.Loader();
  var file = ev.target.files[0];
  loader.loadFromBlob(file, loadHandler);
  $(this).val(null);
});

var loader = new Nar.Loader();
loader.loadFromURL("../node_modules/ikagaka.nar.js/vendor/mobilemaster.nar", loadHandler);

function loadHandler(err, nar){
  if(!!err) return console.error(err.stack);

  console.log(nar);

  if(nar.install["type"] === "ghost"){
    var dic = nar.getDirectory(/shell\/master\//);
    var shellDir = Object.keys(dic).reduce(function(_dic, path){
      _dic[path] = dic[path].asArrayBuffer();
      return _dic;
    }, {});
    var shell = new Shell(shellDir);
  }else if(nar.install.type === "shell"){
    var shell = new Shell(nar.directory);
  }else{
    throw new Error("wrong nar file");
  }

  shell.load().then(function(shell){
    if(!!err) return console.error(err.stack);

    console.log(shell);

    var $wrapper = $("<div style='display:inline-block;' />")
    var $canvas = $("<canvas />")

    $wrapper.on("IkagakaDOMEvent", function(ev){ console.log(ev.detail); });

    $canvas.appendTo($wrapper);
    $wrapper.appendTo("body");

    $("#surfaceId").change(function(ev){ changeSurface(Number($(ev.target).val())); });

    var surface;

    changeSurface(0);

    setInterval(function(){
      if(surface != null){
        surface.talk();
      }
    }, 100);

    function changeSurface(n){
      if(surface != null){
        surface.destructor();
      }
      surface = shell.attachSurface($canvas[0], 0, n);
      if(surface != null){
        surface.bind(30);
        surface.bind(31);
        surface.bind(32);
        surface.bind(50);
      }

      console.log(surface);
    }

  });

}
</script>
